# v1.0plus 功能缺口与开发方案

## 0. 说明与输入范围
- 已阅读：`design/doc/v1/*`、`design/src/pages/*`。
- **design/doc/v3 未在仓库内找到**（`design/doc` 目录下仅有 v1 文件）。因此以下缺口基于 *v1 设计文档 + design/src 页面原型 + 当前系统代码* 进行初步梳理；若后续补充 v3 文档，需要再次核对并更新。

## 1. 功能缺口总览（初步）
| 编号 | 模块 | 设计侧目标（来自 v1 + design/src） | 当前状态 | 优先级 |
|---|---|---|---|---|
| A1 | 管理后台 | 用户 Token 监测（UserMonitor） | 前端页面/路由/后端接口/数据存储均缺失 | 高 |
| A2 | 管理后台 | 区域/星域管理增强（AI 描述、批量导入、图片上传、删除、下拉关联） | UI/接口/DB 字段部分缺失 | 高 |
| A3 | 管理后台 | 角色档案增强（批量导入、图片上传、头像/简介字段） | UI/接口/DB 字段缺失 | 中 |
| A4 | 管理后台 | 管理员认证与 RBAC | 后端未保护 `/api/admin/**`；前端仅本地标记 | 高 |
| G1 | 游戏主界面 | LLM 结构化回复 + 意图解析 + 状态更新 | 目前为模拟回复，无 JSON 指令解析 | 高 |
| G2 | 记忆系统 | RAG 检索与“回忆”交互 | 仅展示固定记忆；无 RAG 或回忆交互 | 中 |
| G3 | 地图系统 | 用户解锁进度（`/api/user/progress`） | 地图解锁为全局字段，无用户维度 | 中 |
| G4 | 资源呈现 | 真实背景/立绘资源与预加载 | 仍使用 CSS 渐变/占位 | 低 |

> 说明：上表中的“设计侧目标”来源于 v1 文档与 design/src 页面原型（包含 UserMonitor、批量导入、图片上传等交互）。若 v3 中新增/修改功能，请补充到该表。

---

## 2. 详细开发方案

### A1. 用户 Token 监测（UserMonitor）
**缺口确认**
- design/src 提供 `UserMonitor` 页面与交互原型，但 `frontend/src/pages/admin` 无该页面与路由。
- 后端 `AdminController` 未提供使用统计与限额接口。
- DB 无 Token 统计与限额字段。

**开发方案**
1. **数据库/结构**（更新 `sql/schema.sql`）
   - 新表：`user_token_usage`
     - 字段：`id`, `user_id`, `input_tokens`, `output_tokens`, `updated_at`
   - 新表：`user_token_limit`
     - 字段：`id`, `user_id`, `custom_limit`
   - 新表：`system_setting`
     - 字段：`id`, `key`, `value`（用于存储 `global_token_limit`）
2. **后端**
   - 新增统计更新逻辑：在 LLM 请求完成后写入 `input_tokens` / `output_tokens`。
   - 新增接口：
     - `GET /api/admin/users/usage`：返回用户 Token 统计与限额。
     - `POST /api/admin/settings/global-limit`：更新全局限额。
     - `POST /api/admin/users/{id}/limit`：更新单用户限额。
   - 超限拦截：在聊天入口或 LLM 调用前检查加权总量（Input*1 + Output*8）。
3. **前端**
   - 迁移 design/src `UserMonitor` 至 `frontend/src/pages/admin`。
   - 在 `AdminLayout` 添加导航项与路由：`/admin/dashboard/monitor`。
   - 调用新增接口替换 mock 数据与 toast。
4. **测试**
   - 单元测试：统计更新、超限判断、加权计算。
   - API 测试：全局/单用户限额更新。

---

### A2. 区域与星域管理增强
**缺口确认**
- design/src 提供批量 JSON 导入、图片上传、删除、AI 描述字段与星域下拉选择。
- 当前前端 `LocationManager` 缺失：批量导入、图片上传、删除、星域下拉、AI 描述字段绑定。
- 当前 DB `star_domain` / `location` 无 `ai_description` 字段。

**开发方案**
1. **数据库/结构**（更新 `sql/schema.sql`）
   - `star_domain` 增加 `ai_description TEXT`。
   - `location` 增加 `ai_description TEXT`。
   - 若需要存储背景图 URL，考虑新增 `background_url`，或复用 `background_style` 改名为更清晰的字段（注意兼容）。
2. **后端**
   - Entity/DTO 增加 `aiDescription` 字段。
   - 新增批量导入接口：`POST /api/admin/world/batch`。
     - 支持识别 JSON 是 `domain` 还是 `location` 数组。
   - 新增图片上传接口：`POST /api/upload/image`，返回可访问 URL。
   - 可选：增加删除接口 `DELETE /api/admin/world/domains/{id}`、`DELETE /api/admin/world/locations/{id}`。
3. **前端**
   - 接入批量导入按钮与 JSON 解析提示。
   - 添加图片上传按钮，调用上传 API 并自动回填 URL。
   - 星域选择改用下拉选择（展示星域名称，值为 code/id）。
   - 绑定并保存 `aiDescription` 与 `backgroundUrl` 字段。
4. **测试**
   - 批量导入 JSON 解析/错误处理。
   - 图片上传接口联通。
   - 表单保存后字段完整性校验。

---

### A3. 角色档案管理增强
**缺口确认**
- design/src 提供批量 JSON 导入、图片上传、角色头像 URL 与简介字段。
- 当前 DB `npc_character` 仅有 `name/prompt/role`，缺少 `desc`/`avatarUrl`。

**开发方案**
1. **数据库/结构**
   - `npc_character` 增加 `description TEXT`、`avatar_url VARCHAR(500)`。
2. **后端**
   - Entity/DTO 增加 `description`、`avatarUrl`。
   - 新增 `POST /api/admin/world/characters/batch`。
   - 复用 `POST /api/upload/image` 做头像上传。
3. **前端**
   - 迁移 design/src 的 JSON 导入与图片上传 UI。
   - 绑定 `desc/avatarUrl` 并保存。
4. **测试**
   - 批量导入字段兼容性（缺失字段容错）。

---

### A4. 管理员认证与 RBAC
**缺口确认**
- 后端 `SecurityConfig` 当前对 `/api/admin/**` 不做限制。
- 前端 `AdminLogin` 仅通过 `localStorage` 标记登录。

**开发方案**
1. **后端**
   - 添加管理员凭证来源：`application.yml` 或环境变量 `ADMIN_USERNAME/ADMIN_PASSWORD`。
   - 新增 `POST /api/admin/login`，返回带 `role=ADMIN` 的 JWT。
   - `SecurityConfig` 对 `/api/admin/**` 进行角色校验（仅 ADMIN 可访问）。
2. **前端**
   - `AdminLogin` 走真实登录 API，保存 token。
   - Admin 路由守卫检查 token + role。
3. **测试**
   - 未授权访问 `/api/admin/**` 应拒绝。

---

### G1. LLM 结构化回复与意图驱动
**缺口确认**
- 当前 `GameService` 仍为模拟回复，不符合 `ai_prompt_design.md` 的 JSON 协议与意图解析要求。

**开发方案**
1. **后端**
   - 引入 Spring AI 统一调用模型；读取 `llm_setting` 作为运行时配置。
   - 实现 Prompt 组装：System Prompt + 动态 Context + 用户输入模板。
   - 解析 JSON 输出（字段：`content`, `emotion`, `narration`, `intent`, `target_id`）。
   - 根据 intent 执行状态更新：旅行/赠礼/交互。
   - ChatResponse 需要带 `state_update` 与 `emotion`；必要时扩展 DTO。
2. **前端**
   - 处理 `emotion` 更新立绘。
   - 支持 `state_update`，包括地点/物品变化。
3. **测试**
   - JSON 解析失败的兜底策略。
   - intent 执行逻辑覆盖（travel/gift/interact）。

---

### G2. 记忆回廊与 RAG
**缺口确认**
- 当前记忆为固定列表，无向量检索与“回忆”动作。

**开发方案**
1. **后端**
   - 接入 ChromaDB/Vector DB，存储记忆文本向量。
   - 发送聊天时检索相关记忆并注入 Prompt。
   - 可新增 `POST /api/game/memory/recall`：前端点击记忆触发“回忆”对话。
2. **前端**
   - 记忆卡片可点击，触发 recall 请求并展示 AI 回复。

---

### G3. 地图解锁与用户进度
**缺口确认**
- 设计要求用户进度；当前 `location.unlocked` 为全局字段。

**开发方案**
1. **数据库/结构**
   - 新增 `user_location_unlock`（`user_id`, `location_id`, `unlocked_at`）。
2. **后端**
   - 新增 `GET /api/user/progress` 或在 `/api/world/map` 中返回用户解锁状态。
3. **前端**
   - MapInterface 根据用户解锁状态展示锁/解锁。

---

### G4. 资源呈现与预加载
**缺口确认**
- 当前前端仍使用 CSS 渐变、占位图片。

**开发方案**
1. **后台资源配置**
   - 使用 FireflyAsset + Location 背景 URL 作为真实资源。
2. **前端**
   - `CharacterLayer` 使用真实图片/Live2D 资源。
   - 背景使用 `<img>` 并在切换前预加载。

---

