# V0.2.0 安全与性能注意事项

## 1. 安全注意事项

1. **API Key 保护**
   - 后端存储建议加密（如 AES）或至少返回脱敏字段（仅展示前后几位）。
   - 不在日志中打印 `apiKey`、请求头或完整请求体。

2. **SSRF 风险防护**
   - 管理员配置的 baseUrl 可能导致 SSRF。
   - 建议限制协议（仅 http/https）、禁止内网地址（如 127.0.0.1/169.254.0.0/8）或提供白名单。

3. **权限控制**
   - `/api/admin/**` 必须保持仅 ADMIN 访问。
   - 新增 API 池接口也应继承该权限。

4. **管理员账号配置**
   - `app.admins` 应通过环境变量或私密配置文件注入，不提交到版本库。
   - 禁止使用弱口令，至少 12 位或复杂度策略。

5. **熔断与重试**
   - 避免在失败时无限重试；重试策略需设定上限。
   - 避免健康检查与业务流量重复打到异常 API，造成放大效应。

6. **输入校验**
   - baseUrl / modelName / name 等字段需校验长度与合法字符。
   - tokenLimit / maxLoad 需限制最小与最大值。

## 2. 性能注意事项

1. **负载统计开销**
   - 30s 调用统计应使用滑动窗口或时间桶，避免每次查询全表。
   - 多实例部署建议使用 Redis 计数或集中化统计。

2. **Token 统计更新**
   - 更新 tokenUsed 和 failureCount 建议在同一事务内完成，避免并发覆盖。
   - 可使用 `@Version` 乐观锁减少冲突。

3. **LLM 调用超时**
   - RestTemplate 需设置连接/读取超时（防止线程耗尽）。
   - 建议使用连接池（如 HttpClient/OkHttp）。

4. **健康检查频率**
   - 固定间隔 10 分钟探测，不要在熔断状态每次请求都探测。

5. **图片复用与缓存**
   - 前端使用 `imageCache` 去重预加载。
   - 后端资源响应加 `Cache-Control` 头，避免重复流量。

## 3. 监控与告警建议

- 记录 API 的失败次数、熔断次数、恢复次数。
- 记录 API 池的 tokenUsed、剩余量与负载。
- 若连续失败超过阈值或可用 API 为空，应产生日志告警。

