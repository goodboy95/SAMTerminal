# V0.2.0 功能测试点清单

> 目标：覆盖 API 池、熔断、负载均衡、会话绑定、图片复用及管理员配置等功能的完整链路验证。

## 1. 前端图片复用

1. **重复 URL 仅加载一次**
   - 前置：同一 `backgroundUrl` 被多个 location 引用。
   - 步骤：进入游戏页面，打开 DevTools Network。
   - 期望：同一 URL 的图片只出现 1 次网络请求；后续触发 map 或状态更新不重复拉取。

2. **立绘资源复用**
   - 前置：多次切换情绪但 URL 不变。
   - 步骤：进入聊天界面，使情绪在相同 URL 情况下切换。
   - 期望：不会重复触发网络请求。

## 2. API 池配置与展示

1. **新增 API**
   - 步骤：后台新增一条 API，填写 baseUrl/apiKey/model/role/tokenLimit/maxLoad。
   - 期望：列表中出现新记录，状态为 ACTIVE，tokenUsed=0。

2. **编辑 API**
   - 步骤：修改 modelName 或 temperature。
   - 期望：保存成功且不会重置 tokenUsed。

3. **删除 API**
   - 步骤：删除一条 API。
   - 期望：列表中移除，若该 API 正在被会话使用则提示并阻止或强制切换。

4. **重置 tokenUsed**
   - 步骤：点击“重置 token”按钮。
   - 期望：tokenUsed 归零，updatedAt 更新。

## 3. Token 计数与阈值

1. **Token 递增**
   - 步骤：使用 API 发送 1 次聊天请求。
   - 期望：对应 API 的 tokenUsed 增加（基于返回 usage 或估算）。

2. **Token 耗尽**
   - 步骤：将 tokenLimit 设置为小值，连续调用直到超限。
   - 期望：被判定为不可用，选择逻辑跳过该 API。

3. **“将要耗尽”判定**
   - 步骤：设置 tokenLimit 和阈值，使剩余 token < threshold。
   - 期望：主 API 的选择策略进入“将要耗尽”分支。

## 4. 负载统计与负载均衡

1. **30s 调用计数**
   - 步骤：在 30s 内对同一 API 发起 N 次请求。
   - 期望：后台显示 currentLoad=N（或接近）；超过 30s 后自动下降。

2. **maxLoad 生效**
   - 步骤：设置 maxLoad=2，在 30s 内发起第 3 次请求。
   - 期望：第三次请求触发选择其他 API 或返回“无可用 API”。

3. **负载差值优先**
   - 步骤：主 API A/B 的 `maxLoad-currentLoad` 不同。
   - 期望：优先选择差值最大的 API。

## 5. 熔断与健康检查

1. **连续失败熔断**
   - 步骤：将 API baseUrl 设置为无效，连续请求 3 次。
   - 期望：状态变为 CIRCUIT_OPEN。

2. **熔断后不被选中**
   - 步骤：存在正常 API 与熔断 API。
   - 期望：熔断 API 不参与选路。

3. **10 分钟探测恢复**
   - 步骤：熔断后修复 baseUrl，等待定时健康检查。
   - 期望：成功后状态恢复为 ACTIVE。

## 6. 会话绑定与切换

1. **新会话选择 API**
   - 步骤：新登录或新 sessionId 创建会话。
   - 期望：后端绑定一个 API 并记录在 session。

2. **会话内固定 API**
   - 步骤：在同一会话内多次聊天。
   - 期望：请求始终使用同一 API。

3. **API 失败触发切换**
   - 步骤：绑定的 API 故障。
   - 期望：自动切换到新 API，之后不自动回切。

4. **无可用 API**
   - 步骤：所有主/备 API 都不可用。
   - 期望：返回明确错误信息。

## 7. 主/备 API 选择规则

1. **主 API 优先**
   - 步骤：主 API 与备用 API 均正常。
   - 期望：选择主 API。

2. **主 API 不可用时选备**
   - 步骤：所有主 API 熔断或耗尽。
   - 期望：转向备用 API。

## 8. 管理员配置

1. **application.yml 配置生效**
   - 步骤：配置多个管理员账号并重启。
   - 期望：这些账号可以登录后台。

2. **密码更新**
   - 步骤：修改配置中的密码并重启。
   - 期望：新密码可用，旧密码失效。

3. **安全权限**
   - 步骤：使用非管理员账号访问 `/api/admin/**`。
   - 期望：返回 403。

## 9. 回归测试（核心流程）

- 登录/注册流程
- 游戏聊天/地图/背包/记忆回廊
- 后台星域/角色/立绘配置
- Token 监控页

