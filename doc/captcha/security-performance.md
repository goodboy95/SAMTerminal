# 注册邮件验证：安全 & 性能注意事项

更新时间：2025-12-21

## 1. 安全（必须项）

### 1.1 不信任前端：后端必须二次校验 CAP
需求写的是“点击发送验证邮件时先进行客户端验证（使用 CAP）”，但安全上必须做到：
- 后端 `POST /api/auth/register/email-code/send` 必须验证 `capToken`，否则脚本可直接绕过前端 UI 调用发送接口。

### 1.2 验证码存储：用于校验的字段建议哈希化
用于校验的主表建议：
- `email_verification_request.codeHash` 存储哈希（例如 `SHA-256(code + salt)`），不存明文

发送日志需要“管理员可查看验证码”，本项目按你确认的方案采用：
- `email_send_log.codeEncrypted` **默认加密存储**（不存明文 code）
- 管理端日志列表接口默认只返回 `codeMasked`（例如 `12****34`）
- 管理端提供单独的“解密查看”接口按条解密返回明文 code，并记录审计日志

加密实现建议：
- 算法：`AES-256-GCM`（每条记录独立随机 `iv`，并存储 `iv + ciphertext + tag`）
- 密钥来源：环境变量（例如 `EMAIL_LOG_CODE_ENC_KEY_BASE64`），禁止硬编码进仓库
- 访问控制：仅 ADMIN 可调用解密接口；解密操作写入审计日志（管理员用户名、IP、时间、logId）
- 密钥轮换：保留 `keyVersion` 字段（或在 ciphertext 前缀版本号），支持平滑轮换

### 1.3 防枚举与信息泄露
发送验证码接口与注册接口的错误信息应避免泄露“邮箱是否存在/是否已注册/是否发过码”等细节：
- 发送验证码失败（被封禁、无 SMTP、重发间隔）可以返回明确错误码，但 message 避免给攻击者过多信息。
- 注册失败（验证码错误/过期）提示应统一风格，避免可用作枚举信号。

### 1.4 频控：分层限流
需求已有“重发间隔 1 分钟”与“IP 未验证超过 50 自动封禁”，仍建议补齐：
- **邮箱级**：同一邮箱（或邮箱+IP） 1 分钟内只允许发送 1 次。
- **IP 级**：`/email-code/send`、`/email-code/verify` 做限流（例如每 IP 每分钟 N 次），避免成本放大。
- **全局**：对 SMTP 池加总并发上限（避免线程/连接被打满）。

建议给出默认阈值（可配置化）：
- `POST /api/auth/register/email-code/send`：每 IP `10/min`；同一邮箱 `1/min`（并返回 `resendAvailableAt`）
- `POST /api/auth/register/email-code/verify`：每 IP `30/min`（避免暴力猜码）

实现建议：
- 单实例：可用内存令牌桶（进程重启会清零，适用于开发/小规模）
- 多实例：建议 Redis（统一计数，避免水平扩容后绕过限流）

### 1.5 IP 获取与可信代理
封禁依赖“来源 IP”，需要明确：
- 若 Nginx 反代：后端应从 `X-Forwarded-For`（或 `X-Real-IP`）解析真实 IP，并只信任来自本地反代的该头。
- 必须防止客户端伪造 IP 头绕过封禁（仅对可信代理 IP 段启用该头解析）。

### 1.6 手动封禁 vs 自动封禁的解封规则
实现上务必区分：
- `MANUAL`：只允许管理员解封或到 `bannedUntil` 自动解封；不得因未验证数下降而解封
- `AUTO`：可因未验证数下降自动解封；跨日自动解封

## 2. 安全（推荐项）

### 2.1 SMTP 密码/凭证管理
SMTP 配置属于高敏信息：
- 数据库中建议加密保存（例如 AES-GCM，密钥来自环境变量/密钥管理）
- 管理端列表返回时要脱敏（不返回明文密码）
- 管理端更新密码：空值表示不变（与现有 LLM API 池更新方式一致）

### 2.2 审计日志
对管理员操作建议留痕（后续可扩展）：
- 新增/修改/删除 SMTP 配置
- 手动封禁/解封 IP

### 2.3 CSRF / CORS
本项目前端与后端同域名不同端口（`8090` vs `8081`）：
- 管理端接口基于 JWT（Authorization header）通常不需要 CSRF，但要设置合理的 CORS 允许来源
- 若未来改为 Cookie，则需补 CSRF 防护

## 3. 性能（必须项）

### 3.1 索引与分页
管理端高频查询：
- 日志按时间范围 + 时间排序：`email_send_log(sentAt)` 必须索引（建议联合 `sentAt,id`）
- IP 统计：不要每次从日志聚合全表；建议增量维护 `daily/total` 汇总表并对 `(date, unverified)` 建索引或按需缓存

### 3.2 清理策略（TTL）
长期运行后：
- `email_verification_request`：过期且已验证/已废弃的记录可定期清理（例如保留 7 天用于排查）
- `email_send_log`：按产品需要保留（例如 90 天），超期清理
- `email_ip_stats_daily`：按需保留（例如 365 天），超期清理

### 3.3 SMTP 连接与超时
发送邮件必须设置合理超时与重试策略：
- 单个 SMTP 发送失败即熔断 + 换池重试（需求要求）
- 每次请求内重试次数建议有限（例如最多尝试 3 个不同 SMTP），避免尾延迟不可控
- 总体并发建议限制（线程池/连接池）

## 4. 性能（推荐项）

### 4.1 CAP 难度与端侧体验
PoW 难度过高会导致：
- 低端设备耗时过长、耗电、卡顿
- 用户多次点“发送邮件”被迫等待

建议做法：
- 选择“防脚本足够、但普通设备 1~3 秒内完成”的难度
- 管理端可配置难度（可选扩展）
